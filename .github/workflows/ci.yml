name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend:
    name: Backend (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
  frontend:
    name: Frontend (Node)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        env:
          CI: false
        run: npm run build


  deploy:
    name: Deploy to Linode
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare artifact (filter out dev caches)
        run: |
          rm -rf .git
      - name: Upload project to server (key or password)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "."
          target: "${{ secrets.REMOTE_APP_DIR }}"

      - name: Run remote deployment (key or password)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          script_stop: true
          script: |
            set -euo pipefail
            export APP_DIR=${{ secrets.REMOTE_APP_DIR }}
            # Install Docker & Compose if missing
            if ! command -v docker >/dev/null 2>&1; then
              curl -fsSL https://get.docker.com | sh
              systemctl enable docker || true
              systemctl start docker || true
            fi
            if ! docker compose version >/dev/null 2>&1; then
              DOCKER_CONFIG=${HOME}/.docker mkdir -p ${DOCKER_CONFIG}/cli-plugins
              curl -SL https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-$(uname -m) -o ${DOCKER_CONFIG}/cli-plugins/docker-compose
              chmod +x ${DOCKER_CONFIG}/cli-plugins/docker-compose
            fi
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"
            
            # Stop existing containers to ensure fresh deployment
            echo "Stopping existing containers..."
            docker compose down || true
            
            # Clean up old images to force rebuild
            echo "Cleaning up old images..."
            docker image prune -f || true
            
            # === DATABASE DEPLOYMENT STRATEGY ===
            echo "ğŸ”„ Starting Database Deployment Strategy..."
            
            # Create backups directory
            mkdir -p backups
            
            # Check deployment scenario
            DEPLOYMENT_TYPE="fresh"
            
            if [ -f "joborra.db" ]; then
              echo "ğŸ“ Found existing SQLite database - EXISTING DEPLOYMENT detected"
              DEPLOYMENT_TYPE="existing"
              
              # Create timestamped backup
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              cp "joborra.db" "backups/joborra_pre_migration_${TIMESTAMP}.db"
              if [ -f "joborra.db-wal" ]; then
                cp "joborra.db-wal" "backups/joborra_pre_migration_${TIMESTAMP}.db-wal" || true
              fi
              if [ -f "joborra.db-shm" ]; then
                cp "joborra.db-shm" "backups/joborra_pre_migration_${TIMESTAMP}.db-shm" || true
              fi
              echo "âœ… SQLite backup created: joborra_pre_migration_${TIMESTAMP}.db"
            else
              echo "ğŸ†• No existing SQLite database found - FRESH DEPLOYMENT detected"
              echo "âœ… Fresh deployment: will use Supabase directly, no migration needed"
            fi
            
            echo "ğŸ“‹ Deployment Type: $DEPLOYMENT_TYPE"
            
            # Setup environment files based on deployment type
            if [ -n "${{ secrets.BACKEND_ENV }}" ]; then
              echo "${{ secrets.BACKEND_ENV }}" > .env
              
              # Configure based on deployment type
              if [ "$DEPLOYMENT_TYPE" = "existing" ]; then
                echo "" >> .env
                echo "# Migration Configuration (Existing Deployment)" >> .env
                echo "USE_SUPABASE=false" >> .env  # Start with SQLite for migration
                echo "MIGRATION_MODE=true" >> .env
                echo "âœ… Environment configured for EXISTING deployment with migration"
              else
                echo "" >> .env
                echo "# Fresh Deployment Configuration" >> .env
                echo "USE_SUPABASE=true" >> .env   # Start with Supabase directly
                echo "MIGRATION_MODE=false" >> .env
                echo "âœ… Environment configured for FRESH deployment (Supabase only)"
              fi
            fi
            
            # Frontend env
            if [ -n "${{ secrets.FRONTEND_ENV }}" ]; then
              echo "${{ secrets.FRONTEND_ENV }}" > frontend/.env.production
            elif [ ! -f frontend/.env.production ]; then
              echo "REACT_APP_API_URL=/api" > frontend/.env.production
            fi
            
            # Install Python for migration (if not available)
            if ! command -v python3 >/dev/null 2>&1; then
              echo "Installing Python3..."
              apt-get update && apt-get install -y python3 python3-pip python3-venv || \
              yum install -y python3 python3-pip || \
              dnf install -y python3 python3-pip || \
              echo "âš ï¸ Could not install Python3, migration will be skipped"
            fi
            
            # === MIGRATION EXECUTION LOGIC ===
            if [ "$DEPLOYMENT_TYPE" = "existing" ]; then
              echo "ğŸ”„ Processing EXISTING deployment - Migration Required"
              
              # Run migration if Python is available and SQLite database exists
              if command -v python3 >/dev/null 2>&1 && [ -f "joborra.db" ]; then
                echo "ğŸš€ Running SQLite to Supabase migration..."
                
                # Create virtual environment for migration
                python3 -m venv migration_env || echo "Using system Python"
                
                # Activate virtual environment if created
                if [ -d "migration_env" ]; then
                  source migration_env/bin/activate
                fi
                
                # Install required packages
                python3 -m pip install --upgrade pip
                python3 -m pip install -r requirements.txt
                
                # Run migration with error handling
                if python3 migrate_production_final.py; then
                  echo "âœ… Migration to Supabase completed successfully"
                  
                  # Update environment to use Supabase
                  sed -i 's/USE_SUPABASE=false/USE_SUPABASE=true/g' .env || \
                  echo "USE_SUPABASE=true" >> .env
                  sed -i 's/MIGRATION_MODE=true/MIGRATION_MODE=false/g' .env || true
                  
                  echo "âœ… Application configured to use Supabase as primary"
                  echo "âœ… SQLite preserved as backup"
                else
                  echo "âŒ Migration failed, keeping SQLite as primary database"
                  echo "âœ… SQLite backup preserved for fallback"
                fi
                
                # Deactivate virtual environment
                deactivate 2>/dev/null || true
              else
                echo "âš ï¸ Skipping migration - Python3 not available or no SQLite database"
              fi
              
            else
              echo "ğŸ†• Processing FRESH deployment - No Migration Needed"
              echo "âœ… Application will use Supabase directly"
              echo "âœ… SQLAlchemy will create tables automatically on first run"
            fi
            
            # === FINAL DEPLOYMENT SUMMARY ===
            echo "ğŸ“Š Final Database Configuration Summary:"
            echo "ğŸ”¹ Deployment Type: $DEPLOYMENT_TYPE"
            
            if [ "$DEPLOYMENT_TYPE" = "existing" ]; then
              if grep -q "USE_SUPABASE=true" .env 2>/dev/null; then
                echo "âœ… Primary Database: Supabase PostgreSQL"
                echo "âœ… Fallback Database: SQLite (preserved as backup)"
                echo "âœ… Migration: Successfully completed"
                echo "âœ… User Data: Preserved and migrated"
              else
                echo "âœ… Primary Database: SQLite (migration failed/skipped)"
                echo "â„¹ï¸ Supabase: Migration was attempted but failed"
                echo "âœ… Backup: SQLite data preserved"
              fi
            else
              echo "âœ… Primary Database: Supabase PostgreSQL"
              echo "âœ… Deployment: Fresh installation"
              echo "âœ… Schema: Will be created automatically"
              echo "â„¹ï¸ Migration: Not required (no existing data)"
            fi
            
            # === END DATABASE DEPLOYMENT STRATEGY ===
            
            # Build and start services
            echo "Building fresh containers..."
            docker compose -f docker-compose.yml build --no-cache
            echo "Starting services..."
            docker compose -f docker-compose.yml up -d
            
            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 30
            
            # Health check and verification
            echo "ğŸ” Performing comprehensive deployment verification..."
            
            # Basic health check
            if curl -f http://localhost:8000/ >/dev/null 2>&1; then
              echo "âœ… API is responding"
            else
              echo "âš ï¸ API health check failed, but continuing..."
            fi
            
            # Run comprehensive verification if Python is available
            if command -v python3 >/dev/null 2>&1; then
              echo "ğŸ” Running comprehensive verification..."
              
              # Activate virtual environment if available
              if [ -d "migration_env" ]; then
                source migration_env/bin/activate
              fi
              
              # Install requests if needed for verification
              python3 -m pip install requests >/dev/null 2>&1 || echo "Could not install requests"
              
              # Run verification script
              if python3 scripts/verify_production_deployment.py --url=http://localhost:8000; then
                echo "âœ… All deployment verifications passed"
              else
                echo "âš ï¸ Some verifications failed, but deployment continues"
              fi
              
              # Check database health
              if python3 scripts/health_monitor.py --report; then
                echo "âœ… Database health check completed"
              else
                echo "âš ï¸ Database health check had issues"
              fi
              
              # Deactivate virtual environment
              deactivate 2>/dev/null || true
            else
              echo "âš ï¸ Python not available for comprehensive verification"
            fi
            
            # Final database configuration summary
            echo ""
            echo "ğŸ“Š Final Production Configuration:"
            if grep -q "USE_SUPABASE=true" .env 2>/dev/null; then
              echo "âœ… Primary Database: Supabase PostgreSQL"
              echo "âœ… Fallback Database: SQLite (preserved as backup)"
              echo "âœ… Migration: Completed successfully"
            else
              echo "âœ… Primary Database: SQLite"
              echo "â„¹ï¸ Supabase: Migration was skipped or failed"
            fi
            
            # Cleanup old images
            docker image prune -f || true
            
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸ“‹ Summary:"
            echo "   - Code deployed and containers rebuilt"
            echo "   - Database migration executed (if applicable)"
            echo "   - SQLite backup preserved for fallback"
            echo "   - Health checks completed"
            echo "   - Application ready for users"